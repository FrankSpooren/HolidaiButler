
name: Deploy Test Frontend & Selected Modules

on:
  push:
    paths:
      - 'customer-portal/frontend/**'
      - 'admin-module/**'
      - 'platform-core/**'
  workflow_dispatch: # optioneel voor handmatige start

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Cache npm
        uses: actions/cache@v3
        with:
          path: ~/.npm
          key: "${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}"
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'
          cache-dependency-path: |
            customer-portal/frontend/package-lock.json
            admin-module/package-lock.json
            platform-core/package-lock.json

      - name: Build selected modules
        run: |
          build_module() {
            MODULE=$1
            echo "üîç Building $MODULE..."
            cd "$GITHUB_WORKSPACE/$MODULE"

            if [ -f package-lock.json ]; then
              npm ci || npm install --prefer-offline
            else
              npm install --prefer-offline
            fi

            if [ -d "frontend" ]; then
              cd frontend
              if [ -f package-lock.json ]; then
                npm ci || npm install --prefer-offline
              else
                npm install --prefer-offline
              fi
              if npm run | grep -q build; then
                npm run build
              else
                echo "‚ö†Ô∏è Geen build script in $MODULE/frontend, overslaan..."
              fi
              cd ..
            else
              if npm run | grep -q build; then
                npm run build
              else
                echo "‚ö†Ô∏è Geen build script in $MODULE, overslaan..."
              fi
            fi

            cd "$GITHUB_WORKSPACE"
          }

          build_module customer-portal/frontend
          build_module admin-module
          build_module platform-core

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H 91.98.71.87 >> ~/.ssh/known_hosts

      - name: Backup current version
        run: |
          ssh root@91.98.71.87 "rsync -av --delete /var/www/test.holidaibutler.com/ /var/www/test-backup/"

      - name: Deploy built files
        run: |
          DEPLOY_PATH="/var/www/test.holidaibutler.com"
          TARGET="root@91.98.71.87:$DEPLOY_PATH"
          RSYNC_CMD="rsync -av --delete --ignore-errors --no-perms"

          for DIR in \
            "$GITHUB_WORKSPACE/customer-portal/frontend/dist" \
            "$GITHUB_WORKSPACE/admin-module/frontend/dist" \
            "$GITHUB_WORKSPACE/platform-core/dist"
          do
            if [ -d "$DIR" ]; then
              echo "‚úÖ Kopieer $DIR naar $TARGET"
              $RSYNC_CMD "$DIR/" "$TARGET/"
            else
              echo "‚ö†Ô∏è Map $DIR bestaat niet, overslaan..."
            fi
          done

      - name: Fix permissions
        run: |
          ssh root@91.98.71.87 "chown -R www-data:www-data /var/www/test.holidaibutler.com && chmod -R 755 /var/www/test.holidaibutler.com"

      - name: Reload Apache
        run: |
          ssh root@91.98.71.87 "systemctl reload apache2"

      - name: Health check
        run: |
          sleep 5
          STATUS=$(curl -o /dev/null -s -w "%{http_code}" https://test.holidaibutler.com)
          if [ "$STATUS" -ne 200 ]; then
            echo "‚ùå Health check failed! Rolling back..."
            ssh root@91.98.71.87 "rsync -av --delete /var/www/test-backup/ /var/www/test.holidaibutler.com/"
            exit 1
          else
            echo "‚úÖ Deployment successful! Status code: $STATUS"
