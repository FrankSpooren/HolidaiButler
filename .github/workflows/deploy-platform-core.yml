# =============================================================================
# Platform Core API Deployment Pipeline - Multi-Environment
# =============================================================================
name: "Deploy: Platform Core API"

on:
  push:
    branches: [dev, test, main]
    paths:
      - 'platform-core/**'
      - '!platform-core/README.md'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'dev'
        type: choice
        options: [dev, test, production]

env:
  NODE_VERSION: '20'
  PM2_PROCESS_NAME: 'holidaibutler-api'
  DEPLOY_PATH: '/var/www/api.holidaibutler.com/platform-core'

jobs:
  setup:
    name: Setup Environment
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.env.outputs.environment }}
      health_url: ${{ steps.env.outputs.health_url }}
    steps:
      - name: Determine environment
        id: env
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            ENV="${{ github.event.inputs.environment }}"
          else
            case "${{ github.ref_name }}" in
              dev) ENV="dev" ;; test) ENV="test" ;; main) ENV="production" ;; *) ENV="dev" ;;
            esac
          fi
          case "$ENV" in
            dev) HEALTH_URL="https://dev.holidaibutler.com/health" ;;
            test) HEALTH_URL="https://test.holidaibutler.com/health" ;;
            production) HEALTH_URL="https://holidaibutler.com/health" ;;
          esac
          echo "environment=$ENV" >> $GITHUB_OUTPUT
          echo "health_url=$HEALTH_URL" >> $GITHUB_OUTPUT

  deploy:
    name: Deploy Platform Core API
    needs: setup
    runs-on: ubuntu-latest
    environment: ${{ needs.setup.outputs.environment }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: platform-core/package-lock.json
      - name: Install dependencies
        working-directory: platform-core
        run: npm ci
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh && chmod 700 ~/.ssh
          echo "${{ secrets.DEPLOY_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H 91.98.71.87 >> ~/.ssh/known_hosts
      - name: Backup and Deploy
        run: |
          ssh root@91.98.71.87 "mkdir -p /var/www/backups/platform-core && cp -r ${{ env.DEPLOY_PATH }} /var/www/backups/platform-core/backup-\$(date +%Y%m%d-%H%M%S) 2>/dev/null || true"
          # Keep only last 5 backups to prevent disk filling up
          ssh root@91.98.71.87 "cd /var/www/backups/platform-core && ls -1 | sort | head -n -5 | xargs -r rm -rf"
          ssh root@91.98.71.87 "mkdir -p ${{ env.DEPLOY_PATH }}"
          rsync -avz --delete --exclude 'node_modules' --exclude '.env' --exclude 'logs' --exclude '.git' platform-core/ root@91.98.71.87:${{ env.DEPLOY_PATH }}/
      - name: Configure TTS credentials
        env:
          GOOGLE_TTS_KEY: ${{ secrets.GOOGLE_CLOUD_TTS_KEY }}
        if: env.GOOGLE_TTS_KEY != ''
        run: |
          ssh root@91.98.71.87 "mkdir -p ${{ env.DEPLOY_PATH }}/config"
          echo '${{ secrets.GOOGLE_CLOUD_TTS_KEY }}' | ssh root@91.98.71.87 "cat > ${{ env.DEPLOY_PATH }}/config/google-tts-credentials.json && chmod 600 ${{ env.DEPLOY_PATH }}/config/google-tts-credentials.json"
      - name: Install dependencies and restart PM2
        run: |
          ssh root@91.98.71.87 "pm2 stop ${{ env.PM2_PROCESS_NAME }} 2>/dev/null || true; cd ${{ env.DEPLOY_PATH }} && rm -rf node_modules && npm ci --omit=dev && mkdir -p logs"
          # Robust PM2 restart: try restart first, if fails then delete and start fresh
          ssh root@91.98.71.87 "pm2 restart ${{ env.PM2_PROCESS_NAME }} --update-env 2>/dev/null || (pm2 delete ${{ env.PM2_PROCESS_NAME }} 2>/dev/null; pm2 start ${{ env.DEPLOY_PATH }}/src/index.js --name ${{ env.PM2_PROCESS_NAME }} --cwd ${{ env.DEPLOY_PATH }})"
          ssh root@91.98.71.87 "pm2 save"
      - name: Health check
        run: |
          sleep 5
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" ${{ needs.setup.outputs.health_url }})
          echo "Health: $STATUS - Platform Core API deployed to ${{ needs.setup.outputs.environment }}"
