# =============================================================================
# Customer Portal Deployment Pipeline - Multi-Environment
# =============================================================================
name: "Deploy: Customer Portal"

on:
  push:
    branches: [dev, test, main]
    paths:
      - 'customer-portal/**'
      - '!customer-portal/README.md'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'dev'
        type: choice
        options: [dev, test, production]

env:
  NODE_VERSION: '20'
  MODULE_PATH: 'customer-portal/frontend'

jobs:
  setup:
    name: Setup Environment
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.env.outputs.environment }}
      deploy_url: ${{ steps.env.outputs.deploy_url }}
      deploy_path: ${{ steps.env.outputs.deploy_path }}
    steps:
      - name: Determine environment
        id: env
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            ENV="${{ github.event.inputs.environment }}"
          else
            case "${{ github.ref_name }}" in
              dev) ENV="dev" ;; test) ENV="test" ;; main) ENV="production" ;; *) ENV="dev" ;;
            esac
          fi
          case "$ENV" in
            dev) DEPLOY_URL="dev.holidaibutler.com"; DEPLOY_PATH="/var/www/dev.holidaibutler.com" ;;
            test) DEPLOY_URL="test.holidaibutler.com"; DEPLOY_PATH="/var/www/test.holidaibutler.com" ;;
            production) DEPLOY_URL="holidaibutler.com"; DEPLOY_PATH="/var/www/holidaibutler.com" ;;
          esac
          echo "environment=$ENV" >> $GITHUB_OUTPUT
          echo "deploy_url=$DEPLOY_URL" >> $GITHUB_OUTPUT
          echo "deploy_path=$DEPLOY_PATH" >> $GITHUB_OUTPUT

  build:
    name: Build Customer Portal
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: ${{ env.MODULE_PATH }}/package-lock.json
      - name: Install and Build
        working-directory: ${{ env.MODULE_PATH }}
        env:
          VITE_SENTRY_DSN: ${{ secrets.VITE_SENTRY_DSN }}
        run: |
          npm ci
          cat > .env.production << 'ENVFILE'
          VITE_API_URL=/api/v1
          VITE_ENABLE_HOLIBOT=true
          VITE_MAP_DEFAULT_LAT=38.6447
          VITE_MAP_DEFAULT_LNG=0.0410
          VITE_DEFAULT_LANGUAGE=nl
          VITE_APP_NAME=HolidaiButler
          ENVFILE
          echo "VITE_ENVIRONMENT=${{ needs.setup.outputs.environment }}" >> .env.production
          echo "VITE_SENTRY_DSN=$VITE_SENTRY_DSN" >> .env.production
          npm run build
      - uses: actions/upload-artifact@v4
        with:
          name: customer-portal-dist-${{ needs.setup.outputs.environment }}
          path: ${{ env.MODULE_PATH }}/dist
          retention-days: 1

  deploy:
    name: Deploy to ${{ needs.setup.outputs.environment }}
    needs: [setup, build]
    runs-on: ubuntu-latest
    environment: ${{ needs.setup.outputs.environment }}
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: customer-portal-dist-${{ needs.setup.outputs.environment }}
          path: dist
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh && chmod 700 ~/.ssh
          echo "${{ secrets.DEPLOY_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H 91.98.71.87 >> ~/.ssh/known_hosts
      - name: Deploy
        run: |
          ssh root@91.98.71.87 "mkdir -p /var/www/backups/customer-portal-${{ needs.setup.outputs.environment }}"
          ssh root@91.98.71.87 "cp -r ${{ needs.setup.outputs.deploy_path }} /var/www/backups/customer-portal-${{ needs.setup.outputs.environment }}/backup-\$(date +%Y%m%d-%H%M%S) 2>/dev/null || true"
          rsync -avz --delete dist/ root@91.98.71.87:${{ needs.setup.outputs.deploy_path }}/
          ssh root@91.98.71.87 "chown -R www-data:www-data ${{ needs.setup.outputs.deploy_path }} && chmod -R 755 ${{ needs.setup.outputs.deploy_path }} && systemctl reload apache2"
      - name: Health check
        run: |
          sleep 5
          STATUS=$(curl -o /dev/null -s -w "%{http_code}" https://${{ needs.setup.outputs.deploy_url }})
          echo "Status: $STATUS - Deployed to ${{ needs.setup.outputs.deploy_url }}"
          [ "$STATUS" -ne 200 ] && exit 1 || exit 0
