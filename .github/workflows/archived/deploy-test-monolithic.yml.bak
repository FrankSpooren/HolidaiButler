
name: Deploy Test Frontend & Backend

on:
  push:
    branches:
      - main
    paths:
      - 'customer-portal/frontend/**'
      - 'admin-module/**'
      - 'platform-core/**'

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. Haal code op
      - name: Checkout code
        uses: actions/checkout@v3

      # 2. Cache npm dependencies
      - name: Cache npm
        uses: actions/cache@v3
        with:
          path: ~/.npm
          key: "${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}"
          restore-keys: |
            ${{ runner.os }}-node-

      # 3. Installeer Node.js + caching voor geselecteerde modules
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'
          cache-dependency-path: |
            customer-portal/frontend/package-lock.json
            admin-module/package-lock.json
            platform-core/package-lock.json

      # 4. Build Customer Portal Frontend met production environment
      - name: Build Customer Portal Frontend
        run: |
          cd $GITHUB_WORKSPACE/customer-portal/frontend
          npm ci || npm install --prefer-offline

          # Create .env.production for Vite build
          cat > .env.production << 'EOF'
          VITE_API_URL=https://test.holidaibutler.com/api/v1
          VITE_WIDGET_API_URL=https://test.holidaibutler.com/api/v1
          VITE_ADMIN_API_URL=https://test.holidaibutler.com/api/v1
          VITE_TICKETING_API_URL=https://test.holidaibutler.com/api/v1
          VITE_PAYMENT_API_URL=https://test.holidaibutler.com/api/v1
          VITE_RESERVATIONS_API_URL=https://test.holidaibutler.com/api/v1
          VITE_AGENDA_API_URL=https://test.holidaibutler.com/api/v1
          VITE_ENABLE_TICKETING=true
          VITE_ENABLE_PAYMENTS=true
          VITE_ENABLE_RESERVATIONS=true
          VITE_ENABLE_AGENDA=true
          VITE_ENABLE_HOLIBOT=true
          VITE_MAP_DEFAULT_LAT=38.6447
          VITE_MAP_DEFAULT_LNG=0.0410
          VITE_MAP_DEFAULT_ZOOM=14
          VITE_DEFAULT_LANGUAGE=nl
          VITE_APP_NAME=HolidaiButler
          EOF

          # Remove leading whitespace from heredoc
          sed -i 's/^[[:space:]]*//' .env.production

          # Build with production environment
          npm run build

          echo "✅ Customer Portal Frontend built with production API URLs"

      # 5. Build Platform Core (Backend API)
      - name: Build Platform Core Backend
        run: |
          cd $GITHUB_WORKSPACE/platform-core
          npm ci || npm install --prefer-offline

          # Build if build script exists
          if npm run build --if-present; then
            echo "✅ Platform Core built successfully"
          else
            echo "ℹ️ No build script, using source directly"
          fi

      # 6. Setup SSH
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          echo "${{ secrets.DEPLOY_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H 91.98.71.87 >> ~/.ssh/known_hosts

      # 7. Backup huidige versie
      - name: Backup current version
        run: |
          ssh root@91.98.71.87 "mkdir -p /var/www/test-backup && rsync -av --delete /var/www/test.holidaibutler.com/ /var/www/test-backup/ || true"

      # 8. Deploy Frontend static files
      - name: Deploy Frontend
        run: |
          rsync -av --delete \
            $GITHUB_WORKSPACE/customer-portal/frontend/dist/ \
            root@91.98.71.87:/var/www/test.holidaibutler.com/

      # 9. Deploy Backend API
      - name: Deploy Backend API
        run: |
          # Create backend directory structure if not exists
          ssh root@91.98.71.87 "mkdir -p /var/www/api.holidaibutler.com/platform-core"

          # Deploy platform-core backend to correct subdirectory
          # IMPORTANT: Deploy to platform-core/ subdirectory, NOT root api directory
          # The PM2 process expects code at /var/www/api.holidaibutler.com/platform-core/src/
          rsync -av --delete \
            --exclude 'node_modules' \
            --exclude '.env' \
            --exclude 'logs' \
            $GITHUB_WORKSPACE/platform-core/ \
            root@91.98.71.87:/var/www/api.holidaibutler.com/platform-core/

      # 10. Install backend dependencies and restart service
      - name: Setup Backend Service
        run: |
          ssh root@91.98.71.87 << 'ENDSSH'
            cd /var/www/api.holidaibutler.com/platform-core

            # Install production dependencies
            npm ci --only=production || npm install --only=production

            # Create logs directory
            mkdir -p logs

            # Check if PM2 is installed, install if not
            if ! command -v pm2 &> /dev/null; then
              npm install -g pm2
            fi

            # Start or restart the API with PM2
            # Working directory is /var/www/api.holidaibutler.com/platform-core
            if pm2 describe holidaibutler-api > /dev/null 2>&1; then
              pm2 restart holidaibutler-api
            else
              pm2 start src/index.js --name holidaibutler-api --cwd /var/www/api.holidaibutler.com/platform-core --env production
            fi

            # Save PM2 process list
            pm2 save

            echo "✅ Backend API started/restarted"
          ENDSSH

      # 11. Fix permissies
      - name: Fix permissions
        run: |
          ssh root@91.98.71.87 "chown -R www-data:www-data /var/www/test.holidaibutler.com && chmod -R 755 /var/www/test.holidaibutler.com"

      # 12. Herstart Apache
      - name: Reload Apache
        run: |
          ssh root@91.98.71.87 "systemctl reload apache2"

      # 13. Health check + rollback
      - name: Health check
        run: |
          sleep 10

          # Check frontend
          FRONTEND_STATUS=$(curl -o /dev/null -s -w "%{http_code}" https://test.holidaibutler.com)

          # Check API health endpoint (mounted at /health, not /api/v1/health)
          API_STATUS=$(curl -o /dev/null -s -w "%{http_code}" https://test.holidaibutler.com/health || echo "000")

          echo "Frontend status: $FRONTEND_STATUS"
          echo "API status: $API_STATUS"

          if [ "$FRONTEND_STATUS" -ne 200 ]; then
            echo "❌ Frontend health check failed! Rolling back..."
            ssh root@91.98.71.87 "rsync -av --delete /var/www/test-backup/ /var/www/test.holidaibutler.com/"
            exit 1
          else
            echo "✅ Deployment successful!"
          fi
