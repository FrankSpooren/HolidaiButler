# HolidAIButler Backend Dockerfile
# Mediterranean AI Travel Platform

FROM node:18-alpine AS base

# Install security updates
RUN apk update && apk upgrade && apk add --no-cache \
    dumb-init \
    && rm -rf /var/cache/apk/*

# Create app directory
WORKDIR /app

# Create non-root user
RUN addgroup -g 1001 -S nodejs
RUN adduser -S holidaibutler -u 1001

# Copy package files
COPY package*.json ./

# Development stage
FROM base AS dev
ENV NODE_ENV=development
RUN npm ci --include=dev
COPY --chown=holidaibutler:nodejs . .
USER holidaibutler
EXPOSE 3001
CMD ["dumb-init", "npm", "run", "dev"]

# Production dependencies stage
FROM base AS deps
ENV NODE_ENV=production
RUN npm ci --only=production && npm cache clean --force

# Production stage
FROM base AS production
ENV NODE_ENV=production

# Copy production dependencies
COPY --from=deps --chown=holidaibutler:nodejs /app/node_modules ./node_modules

# Copy application code
COPY --chown=holidaibutler:nodejs . .

# Health check
HEALTHCHECK --interval=30s --timeout=3s --start-period=40s --retries=3 \
  CMD node healthcheck.js

# Switch to non-root user
USER holidaibutler

# Expose port
EXPOSE 3001

# Start application
ENTRYPOINT ["dumb-init", "--"]
CMD ["node", "app.js"]

---

# Docker Compose for Development
# docker-compose.yml

version: '3.8'

services:
  # HolidAIButler Backend
  holidaibutler-backend:
    build:
      context: .
      target: dev
    ports:
      - "3001:3001"
    environment:
      - NODE_ENV=development
      - MONGODB_URI=mongodb://mongo:27017/holidaibutler
      - REDIS_URL=redis://redis:6379
      - CLAUDE_API_KEY=${CLAUDE_API_KEY}
      - JWT_SECRET=${JWT_SECRET}
      - WEATHER_API_KEY=${WEATHER_API_KEY}
    volumes:
      - .:/app
      - /app/node_modules
    depends_on:
      - mongo
      - redis
    restart: unless-stopped
    networks:
      - holidaibutler-network

  # MongoDB Database
  mongo:
    image: mongo:7.0
    ports:
      - "27017:27017"
    environment:
      - MONGO_INITDB_DATABASE=holidaibutler
    volumes:
      - mongo_data:/data/db
      - ./database/init:/docker-entrypoint-initdb.d
    restart: unless-stopped
    networks:
      - holidaibutler-network

  # Redis Cache
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    restart: unless-stopped
    networks:
      - holidaibutler-network
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru

  # Nginx Reverse Proxy
  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./nginx/ssl:/etc/nginx/ssl
    depends_on:
      - holidaibutler-backend
    restart: unless-stopped
    networks:
      - holidaibutler-network

volumes:
  mongo_data:
  redis_data:

networks:
  holidaibutler-network:
    driver: bridge

---

# Kubernetes Deployment
# k8s/deployment.yaml

apiVersion: apps/v1
kind: Deployment
metadata:
  name: holidaibutler-backend
  namespace: holidaibutler
  labels:
    app: holidaibutler-backend
    version: v1.0.0
spec:
  replicas: 3
  selector:
    matchLabels:
      app: holidaibutler-backend
  template:
    metadata:
      labels:
        app: holidaibutler-backend
        version: v1.0.0
    spec:
      containers:
      - name: holidaibutler-backend
        image: holidaibutler/backend:1.0.0
        ports:
        - containerPort: 3001
        env:
        - name: NODE_ENV
          value: "production"
        - name: MONGODB_URI
          valueFrom:
            secretKeyRef:
              name: holidaibutler-secrets
              key: mongodb-uri
        - name: CLAUDE_API_KEY
          valueFrom:
            secretKeyRef:
              name: holidaibutler-secrets
              key: claude-api-key
        - name: JWT_SECRET
          valueFrom:
            secretKeyRef:
              name: holidaibutler-secrets
              key: jwt-secret
        resources:
          requests:
            memory: "256Mi"
            cpu: "250m"
          limits:
            memory: "512Mi"
            cpu: "500m"
        livenessProbe:
          httpGet:
            path: /health
            port: 3001
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /health
            port: 3001
          initialDelaySeconds: 5
          periodSeconds: 5

---
apiVersion: v1
kind: Service
metadata:
  name: holidaibutler-backend-service
  namespace: holidaibutler
spec:
  selector:
    app: holidaibutler-backend
  ports:
  - protocol: TCP
    port: 80
    targetPort: 3001
  type: ClusterIP

---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: holidaibutler-ingress
  namespace: holidaibutler
  annotations:
    kubernetes.io/ingress.class: "nginx"
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
    nginx.ingress.kubernetes.io/rate-limit: "100"
spec:
  tls:
  - hosts:
    - api.holidaibutler.com
    secretName: holidaibutler-tls
  rules:
  - host: api.holidaibutler.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: holidaibutler-backend-service
            port:
              number: 80