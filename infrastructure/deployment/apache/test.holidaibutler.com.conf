# ============================================================================
# Apache Virtual Host Configuration for test.holidaibutler.com
# ============================================================================
# This configuration:
# 1. Serves the static frontend from /var/www/test.holidaibutler.com
# 2. Proxies /api/* requests to the Node.js backend on port 3001
# 3. Handles SPA routing (all non-file requests go to index.html)
#
# Installation on Hetzner server:
# 1. Copy this file to /etc/apache2/sites-available/test.holidaibutler.com.conf
# 2. Enable required modules: a2enmod proxy proxy_http rewrite headers ssl
# 3. Enable the site: a2ensite test.holidaibutler.com.conf
# 4. Test config: apache2ctl configtest
# 5. Reload Apache: systemctl reload apache2
# ============================================================================

<VirtualHost *:80>
    ServerName test.holidaibutler.com

    # Redirect HTTP to HTTPS
    RewriteEngine On
    RewriteCond %{HTTPS} off
    RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
</VirtualHost>

<VirtualHost *:443>
    ServerName test.holidaibutler.com
    DocumentRoot /var/www/test.holidaibutler.com

    # SSL Configuration (adjust paths to your certificate location)
    SSLEngine on
    SSLCertificateFile /etc/letsencrypt/live/test.holidaibutler.com/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/test.holidaibutler.com/privkey.pem

    # Security Headers
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"

    # Enable compression
    <IfModule mod_deflate.c>
        AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript application/javascript application/json
    </IfModule>

    # =========================================================================
    # API REVERSE PROXY - Route /api/* and /health to Node.js backend
    # =========================================================================
    ProxyPreserveHost On
    ProxyRequests Off

    # Proxy health check endpoint
    <Location /health>
        ProxyPass http://127.0.0.1:3001/health
        ProxyPassReverse http://127.0.0.1:3001/health
    </Location>

    # Proxy metrics endpoint (for monitoring)
    <Location /metrics>
        ProxyPass http://127.0.0.1:3001/metrics
        ProxyPassReverse http://127.0.0.1:3001/metrics
    </Location>

    # Proxy API requests to the backend (platform-core on port 3001)
    <Location /api>
        ProxyPass http://127.0.0.1:3001/api
        ProxyPassReverse http://127.0.0.1:3001/api

        # CORS Headers for API
        Header always set Access-Control-Allow-Origin "*"
        Header always set Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS, PATCH"
        Header always set Access-Control-Allow-Headers "Origin, X-Requested-With, Content-Type, Accept, Authorization"

        # Handle preflight OPTIONS requests
        RewriteEngine On
        RewriteCond %{REQUEST_METHOD} OPTIONS
        RewriteRule ^(.*)$ $1 [R=200,L]
    </Location>

    # =========================================================================
    # STATIC FRONTEND
    # =========================================================================
    <Directory /var/www/test.holidaibutler.com>
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted

        # SPA Routing - Serve index.html for all non-file requests
        <IfModule mod_rewrite.c>
            RewriteEngine On
            RewriteBase /

            # Don't rewrite files or directories
            RewriteCond %{REQUEST_FILENAME} !-f
            RewriteCond %{REQUEST_FILENAME} !-d

            # Don't rewrite API requests (handled by proxy)
            RewriteCond %{REQUEST_URI} !^/api
            RewriteCond %{REQUEST_URI} !^/health
            RewriteCond %{REQUEST_URI} !^/metrics

            # Rewrite everything else to index.html for SPA
            RewriteRule ^ index.html [L]
        </IfModule>
    </Directory>

    # Cache static assets
    <IfModule mod_expires.c>
        ExpiresActive On

        # CSS and JavaScript
        ExpiresByType text/css "access plus 1 year"
        ExpiresByType application/javascript "access plus 1 year"

        # Images
        ExpiresByType image/jpeg "access plus 1 year"
        ExpiresByType image/png "access plus 1 year"
        ExpiresByType image/gif "access plus 1 year"
        ExpiresByType image/svg+xml "access plus 1 year"
        ExpiresByType image/webp "access plus 1 year"

        # Fonts
        ExpiresByType font/woff "access plus 1 year"
        ExpiresByType font/woff2 "access plus 1 year"
        ExpiresByType application/font-woff "access plus 1 year"
        ExpiresByType application/font-woff2 "access plus 1 year"

        # HTML - short cache for SPA
        ExpiresByType text/html "access plus 0 seconds"
    </IfModule>

    # Logging
    ErrorLog ${APACHE_LOG_DIR}/test.holidaibutler.com-error.log
    CustomLog ${APACHE_LOG_DIR}/test.holidaibutler.com-access.log combined
</VirtualHost>
